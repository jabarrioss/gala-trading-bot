<!DOCTYPE html>
<html>
  <head>
    <title>Gala Trading Bot - Control Panel</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      .button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
      }
      .button:hover {
        background-color: #45a049;
      }
      .button.danger {
        background-color: #f44336;
      }
      .button.danger:hover {
        background-color: #da190b;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      #results {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-success { background-color: #4CAF50; }
      .status-error { background-color: #f44336; }
      .status-warning { background-color: #ff9800; }
    </style>
  </head>
  <body>
    <h1>ðŸš€ Gala Trading Bot - Control Panel</h1>
    
    <!-- Balance Check Section -->
    <div class="container">
      <h2>ðŸ’° Account Balance</h2>
      <button class="button" onclick="checkGalaBalance()">Check GALA Balance</button>
      <button class="button" onclick="getAllBalances()">Get All Token Balances</button>
      <div id="balance-result"></div>
    </div>

    <!-- Manual Trading Section -->
    <div class="container">
      <h2>ðŸ”„ Manual Trading</h2>
      <div class="form-group">
        <label for="fromToken">From Token (GALA format):</label>
        <input type="text" id="fromToken" value="GALA|Unit|none|none" placeholder="GALA|Unit|none|none">
      </div>
      <div class="form-group">
        <label for="toToken">To Token (GALA format):</label>
        <input type="text" id="toToken" value="GUSDC|Unit|none|none" placeholder="GUSDC|Unit|none|none">
      </div>
      <div class="form-group">
        <label for="amount">Amount:</label>
        <input type="number" id="amount" value="10" step="0.01" min="0.01">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="dryRun" checked> Dry Run Mode (Recommended)
        </label>
      </div>
      <button class="button" onclick="executeSwap()">ðŸ§ª Execute Swap (Dry Run)</button>
      <button class="button danger" onclick="executeSwap(false)">ðŸ’° Execute Live Swap</button>
    </div>

    <!-- Trade History Section -->
    <div class="container">
      <h2>ðŸ“ˆ Trade History & Statistics</h2>
      <div class="form-group">
        <label for="strategyFilter">Filter by Strategy:</label>
        <select id="strategyFilter">
          <option value="">All Strategies</option>
          <option value="Manual">Manual</option>
          <option value="MonitorStrategy_DCA">Monitor DCA</option>
          <option value="MonitorStrategy_GOLDEN_CROSS">Monitor Golden Cross</option>
        </select>
      </div>
      <button class="button" onclick="loadTradeHistory()">ðŸ“Š Load Trade History</button>
      <button class="button" onclick="loadTradeStats()">ðŸ“ˆ Load Trade Statistics</button>
      <div id="trade-history"></div>
    </div>

    <!-- Results Section -->
    <div class="container">
      <h2>ðŸ“Š Results</h2>
      <div id="results">Click buttons above to see results...</div>
    </div>

    <script>
      function updateResults(data, title = 'Result') {
        const resultsDiv = document.getElementById('results');
        const timestamp = new Date().toLocaleTimeString();
        resultsDiv.textContent = `[${timestamp}] ${title}:\n` + JSON.stringify(data, null, 2) + '\n\n' + resultsDiv.textContent;
      }

      async function checkGalaBalance() {
        try {
          const response = await fetch('/users/get-gala-balance');
          const data = await response.json();
          
          const balanceDiv = document.getElementById('balance-result');
          if (data.success) {
            balanceDiv.innerHTML = `
              <p><span class="status-indicator status-success"></span>
              <strong>GALA Balance: ${data.gala_balance} GALA</strong></p>
              <p>${data.message}</p>
            `;
          } else {
            balanceDiv.innerHTML = `
              <p><span class="status-indicator status-error"></span>
              <strong>Error:</strong> ${data.error}</p>
            `;
          }
          
          updateResults(data, 'GALA Balance Check');
        } catch (error) {
          updateResults({error: error.message}, 'GALA Balance Check Error');
        }
      }

      async function getAllBalances() {
        try {
          const response = await fetch('/users/get-balance');
          const data = await response.json();
          
          const balanceDiv = document.getElementById('balance-result');
          if (data.assets) {
            let html = `<p><span class="status-indicator status-success"></span><strong>Found ${data.asset_count} tokens:</strong></p><ul>`;
            data.assets.tokens.forEach(token => {
              html += `<li><strong>${token.symbol}:</strong> ${token.quantity} (${token.name})</li>`;
            });
            html += '</ul>';
            balanceDiv.innerHTML = html;
          }
          
          updateResults(data, 'All Balances');
        } catch (error) {
          updateResults({error: error.message}, 'All Balances Error');
        }
      }

      async function executeSwap(forceDryRun = null) {
        const fromToken = document.getElementById('fromToken').value;
        const toToken = document.getElementById('toToken').value;
        const amount = document.getElementById('amount').value;
        const dryRun = forceDryRun !== null ? forceDryRun : document.getElementById('dryRun').checked;

        if (!fromToken || !toToken || !amount) {
          alert('Please fill in all fields');
          return;
        }

        if (!dryRun && !confirm('Are you sure you want to execute a LIVE trade? This will use real tokens!')) {
          return;
        }

        try {
          const response = await fetch('/users/execute-swap', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fromToken,
              toToken,
              amount: parseFloat(amount),
              dryRun
            })
          });

          const data = await response.json();
          
          const title = dryRun ? 'Swap Execution (Dry Run)' : 'Swap Execution (LIVE)';
          updateResults(data, title);

          if (data.success) {
            alert(`${dryRun ? 'Dry run' : 'Live trade'} completed successfully!`);
          } else {
            alert(`${dryRun ? 'Dry run' : 'Live trade'} failed: ${data.error}`);
          }

        } catch (error) {
          updateResults({error: error.message}, 'Swap Execution Error');
          alert('Error executing swap: ' + error.message);
        }
      }

      // Auto-update dry run button text
      document.getElementById('dryRun').addEventListener('change', function() {
        const button = document.querySelector('.button[onclick="executeSwap()"]');
        if (this.checked) {
          button.textContent = 'ðŸ§ª Execute Swap (Dry Run)';
          button.className = 'button';
        } else {
          button.textContent = 'ðŸ’° Execute Swap (LIVE)';
          button.className = 'button danger';
        }
      });

      async function loadTradeHistory() {
        try {
          const strategy = document.getElementById('strategyFilter').value;
          const queryParams = strategy ? `?strategy=${encodeURIComponent(strategy)}` : '';
          
          const response = await fetch(`/users/trade-history${queryParams}`);
          const data = await response.json();
          
          const historyDiv = document.getElementById('trade-history');
          if (data.success && data.trades.length > 0) {
            let html = `
              <h3>ðŸ“Š Trade Statistics</h3>
              <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px;">
                <strong>Total Trades:</strong> ${data.stats.totalTrades} | 
                <strong>Success Rate:</strong> ${(data.stats.successRate * 100).toFixed(1)}% | 
                <strong>Total Volume:</strong> ${data.stats.totalVolume.toFixed(4)} | 
                <strong>Average Trade:</strong> ${data.stats.averageTradeSize.toFixed(4)}
              </div>
              <h3>ðŸ“‹ Recent Trades (${data.trades.length} records)</h3>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; background: white;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f5f5f5;">
                      <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Strategy</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Symbol</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Side</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Amount</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Price</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
                      <th style="padding: 8px; border: 1px solid #ddd;">Mode</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            data.trades.forEach(trade => {
              const date = new Date(trade.executed_at).toLocaleString();
              const statusColor = trade.status === 'COMPLETED' ? '#4CAF50' : '#f44336';
              const modeColor = trade.dry_run ? '#ff9800' : '#2196F3';
              
              html += `
                <tr>
                  <td style="padding: 6px; border: 1px solid #ddd; font-size: 12px;">${date}</td>
                  <td style="padding: 6px; border: 1px solid #ddd;">${trade.strategy}</td>
                  <td style="padding: 6px; border: 1px solid #ddd;"><strong>${trade.symbol}</strong></td>
                  <td style="padding: 6px; border: 1px solid #ddd;">${trade.side}</td>
                  <td style="padding: 6px; border: 1px solid #ddd;">${trade.amount}</td>
                  <td style="padding: 6px; border: 1px solid #ddd;">${trade.price.toFixed(6)}</td>
                  <td style="padding: 6px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${trade.status}</td>
                  <td style="padding: 6px; border: 1px solid #ddd; color: ${modeColor}; font-weight: bold;">${trade.dry_run ? 'DRY' : 'LIVE'}</td>
                </tr>
              `;
            });
            
            html += '</tbody></table></div>';
            historyDiv.innerHTML = html;
          } else if (data.success) {
            historyDiv.innerHTML = '<p>No trades found for the selected criteria.</p>';
          } else {
            historyDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
          }
          
          updateResults(data, 'Trade History');
        } catch (error) {
          updateResults({error: error.message}, 'Trade History Error');
        }
      }

      async function loadTradeStats() {
        try {
          const strategy = document.getElementById('strategyFilter').value;
          const queryParams = strategy ? `?strategy=${encodeURIComponent(strategy)}` : '';
          
          const response = await fetch(`/users/trade-stats${queryParams}`);
          const data = await response.json();
          
          const historyDiv = document.getElementById('trade-history');
          if (data.success) {
            const stats = data.stats;
            historyDiv.innerHTML = `
              <h3>ðŸ“ˆ Trading Statistics</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #2e7d32;">Total Trades</h4>
                  <div style="font-size: 24px; font-weight: bold; color: #1b5e20;">${stats.totalTrades}</div>
                </div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #1976d2;">Success Rate</h4>
                  <div style="font-size: 24px; font-weight: bold; color: #0d47a1;">${(stats.successRate * 100).toFixed(1)}%</div>
                </div>
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #7b1fa2;">Total Volume</h4>
                  <div style="font-size: 24px; font-weight: bold; color: #4a148c;">${stats.totalVolume.toFixed(4)}</div>
                </div>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 10px 0; color: #f57c00;">Avg Trade Size</h4>
                  <div style="font-size: 24px; font-weight: bold; color: #e65100;">${stats.averageTradeSize.toFixed(4)}</div>
                </div>
              </div>
              <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0;">Detailed Breakdown</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                  <div><strong>Successful:</strong> ${stats.successfulTrades}</div>
                  <div><strong>Failed:</strong> ${stats.failedTrades}</div>
                  <div><strong>Live Trades:</strong> ${stats.liveTrades || 0}</div>
                  <div><strong>Dry Runs:</strong> ${stats.dryRunTrades || 0}</div>
                </div>
              </div>
            `;
          } else {
            historyDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
          }
          
          updateResults(data, 'Trade Statistics');
        } catch (error) {
          updateResults({error: error.message}, 'Trade Statistics Error');
        }
      }

      // Load balance on page load
      window.addEventListener('load', function() {
        checkGalaBalance();
      });
    </script>
  </body>
</html>